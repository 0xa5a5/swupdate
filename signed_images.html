<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Update images from verified source &mdash; Embedded Software Update Documentation 2016.10 documentation</title>
    
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '2016.10',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Embedded Software Update Documentation 2016.10 documentation" href="index.html" />
    <link rel="next" title="Handlers" href="handlers.html" />
    <link rel="prev" title="SWUpdate: syntax and tags with the default parser" href="sw-description.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="handlers.html" title="Handlers"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="sw-description.html" title="SWUpdate: syntax and tags with the default parser"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Embedded Software Update Documentation 2016.10 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="update-images-from-verified-source">
<h1>Update images from verified source<a class="headerlink" href="#update-images-from-verified-source" title="Permalink to this headline">¶</a></h1>
<p>It is becoming very important that a device must not only be safely updated,
but also that it can verify if the delivered image is coming
from a known source and it was not corrupted introducing some malware.</p>
<p>To achieve this goal, SWUpdate must verify the incoming images. There are several
ways to do this. Should the compound image be signed ? Or some parts of it ?</p>
<p>Advantages and disadvantages are described in the following chapter.</p>
<div class="section" id="signing-the-compound-image">
<h2>Signing the compound image<a class="headerlink" href="#signing-the-compound-image" title="Permalink to this headline">¶</a></h2>
<p>It looks quite straightforward if the whole compound image is signed.
However, this has some heavy drawbacks. It is not possible to know if the image
is verified until the whole image is loaded. This means that verification can be
done after installing the single images instead of doing it before touching the
device.
This leads to have some uninstall procedure if part of a not verified image is
already installed, procedures that cannot be safe in case of power off letting
some unwanted piece of software on the device.</p>
</div>
<div class="section" id="signing-the-sub-images">
<h2>Signing the sub-images<a class="headerlink" href="#signing-the-sub-images" title="Permalink to this headline">¶</a></h2>
<p>If each sub-image is signed, the verification is done before calling the
corresponding hardware. Only signed images can be installed.
Anyway, this remains unbound with the description of the release in
sw-description. Even if sw-description is signed, an attacker can mix
signed images together generating a new compound image that can be
installed as well, because all sub-images are verified.</p>
</div>
<div class="section" id="combining-signing-sw-description-with-hash-verification">
<h2>Combining signing sw-description with hash verification<a class="headerlink" href="#combining-signing-sw-description-with-hash-verification" title="Permalink to this headline">¶</a></h2>
<p>To avoid the described drawbacks, SWUpdate combines signed sw-description
with the verification of hashes for each single image. This means that
only sw-description generated by a verified source can be accepted by
the installer. sw-description contains hashes for each sub-image to
verify that each delivered sub-image really belongs to the release.</p>
</div>
<div class="section" id="generating-private-and-public-key">
<h2>Generating private and public key<a class="headerlink" href="#generating-private-and-public-key" title="Permalink to this headline">¶</a></h2>
<p>The openssl tool is used to generate the keys. This is part of the
openSSL project. A complete documentation can be found at
<a class="reference external" href="https://www.openssl.org/docs/manmaster/apps/openssl.html">https://www.openssl.org/docs/manmaster/apps/openssl.html</a>.</p>
<p>First, the private key must be created:</p>
<div class="highlight-python"><div class="highlight"><pre>openssl genrsa -aes256 -out priv.pem
</pre></div>
</div>
<p>This asks for a passphrase. It is possible to retrieve
the passhphrase from a file - of course, this must be
protected against intrusion.</p>
<div class="highlight-python"><div class="highlight"><pre>openssl genrsa -aes256 -passout file:passout -out priv.pem
</pre></div>
</div>
<p>The public key is used to generate the public key with:</p>
<div class="highlight-python"><div class="highlight"><pre>openssl rsa -in priv.pem -out public.pem -outform PEM -pubout
</pre></div>
</div>
<p>&#8220;public.pem&#8221; contains the key in a format suitable for swupdate. The file
can be passed to swupdate at the command line with the -k parameter.</p>
</div>
<div class="section" id="signing-the-swu-image">
<h2>Signing the SWU image<a class="headerlink" href="#signing-the-swu-image" title="Permalink to this headline">¶</a></h2>
<p>Signing the image is very simple:</p>
<div class="highlight-python"><div class="highlight"><pre>openssl dgst -sha256 -sign priv.pem sw-description &gt; sw-description.sig
</pre></div>
</div>
<p>There are two files, sw-description and its signature sw-description.sig.
The signature file must always directly follow the description file.</p>
<p>Each image inside sw-description must have the attribute &#8220;sha256&#8221;, with the
SHA256 sum of the image. If an image does not have the sha256 attribute,
the whole compound image results as not verified and SWUpdate stops
with an error before starting to install.</p>
<p>A simple script to create a signed image can be:</p>
<div class="highlight-python"><div class="highlight"><pre>#!/bin/bash

PRODUCT_NAME=&quot;myproduct&quot;
CONTAINER_VER=&quot;1.0&quot;
IMAGES=&quot;rootfs kernel&quot;
FILES=&quot;sw-description sw-description.sig $IMAGES&quot;

openssl dgst -sha256 -sign priv.pem sw-description &gt; sw-description.sig

for i in $FILES;do
        echo $i;done | cpio -ov -H crc &gt;  ${PRODUCT_NAME}_${CONTAINER_VER}.swu
</pre></div>
</div>
</div>
<div class="section" id="example-for-sw-description-with-signed-image">
<h2>Example for sw-description with signed image<a class="headerlink" href="#example-for-sw-description-with-signed-image" title="Permalink to this headline">¶</a></h2>
<p>The example applies to a Beaglebone, installing Yocto images:</p>
<div class="highlight-python"><div class="highlight"><pre>software =
{
        version = &quot;0.1.0&quot;;

        hardware-compatibility: [ &quot;revC&quot;];

        images: (
                {
                    filename = &quot;core-image-full-cmdline-beaglebone.ext3&quot;;
                    device = &quot;/dev/mmcblk0p2&quot;;
                    type = &quot;raw&quot;;
                    sha256 = &quot;43cdedde429d1ee379a7d91e3e7c4b0b9ff952543a91a55bb2221e5c72cb342b&quot;;
                }
        );
        scripts: (
                {
                    filename = &quot;test.lua&quot;;
                    type = &quot;lua&quot;;
                    sha256 = &quot;f53e0b271af4c2896f56a6adffa79a1ffa3e373c9ac96e00c4cfc577b9bea5f1&quot;;
                 }
        );
}
</pre></div>
</div>
</div>
<div class="section" id="running-swupdate-with-signed-images">
<h2>Running SWUpdate with signed images<a class="headerlink" href="#running-swupdate-with-signed-images" title="Permalink to this headline">¶</a></h2>
<p>Verification is activated by setting CONFIG_SIGNED_IMAGE in SWUpdate&#8217;s configuration.
If activated, SWUpdate will always check the compound image. For security reasons,
it is not possible to disable the check at runtime. The -k parameter (public key file)
is mandatory and the program stops if the public key is not passed.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Update images from verified source</a><ul>
<li><a class="reference internal" href="#signing-the-compound-image">Signing the compound image</a></li>
<li><a class="reference internal" href="#signing-the-sub-images">Signing the sub-images</a></li>
<li><a class="reference internal" href="#combining-signing-sw-description-with-hash-verification">Combining signing sw-description with hash verification</a></li>
<li><a class="reference internal" href="#generating-private-and-public-key">Generating private and public key</a></li>
<li><a class="reference internal" href="#signing-the-swu-image">Signing the SWU image</a></li>
<li><a class="reference internal" href="#example-for-sw-description-with-signed-image">Example for sw-description with signed image</a></li>
<li><a class="reference internal" href="#running-swupdate-with-signed-images">Running SWUpdate with signed images</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="sw-description.html"
                        title="previous chapter">SWUpdate: syntax and tags with the default parser</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="handlers.html"
                        title="next chapter">Handlers</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/signed_images.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="handlers.html" title="Handlers"
             >next</a> |</li>
        <li class="right" >
          <a href="sw-description.html" title="SWUpdate: syntax and tags with the default parser"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Embedded Software Update Documentation 2016.10 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2013-2016, Stefano Babic.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
  </body>
</html>